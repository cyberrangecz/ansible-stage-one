  - name: update retry count
    set_fact:
      retry_count: "{{ 0 if retry_count is undefined else retry_count|int + 1 }}"

  - name: ping windows machine
    win_ping:
    ignore_unreachable: yes
    ignore_errors: yes
    register: ping

  - name: pause before another ping
    pause:
      seconds: 20
    when: ping is unreachable or ping is failed

  - name: fail when retry count reaches 245
    fail:
    when: retry_count|int > 245

  - include_tasks: win_wait_for_connection.yml
    when: ping is unreachable or ping is failed
